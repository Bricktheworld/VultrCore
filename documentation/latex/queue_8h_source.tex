\hypertarget{queue_8h_source}{}\doxysection{queue.\+h}
\label{queue_8h_source}\index{src/types/queue.h@{src/types/queue.h}}
\mbox{\hyperlink{queue_8h}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{// TODO(Brandon): Replace with custom allocator.}}
\DoxyCodeLine{2 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{thread_8h}{thread.h}}"{}}}
\DoxyCodeLine{4 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{types_8h}{types.h}}"{}}}
\DoxyCodeLine{5 }
\DoxyCodeLine{6 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacevtl}{vtl}}}
\DoxyCodeLine{7 \{}
\DoxyCodeLine{8     \textcolor{keyword}{template} <\textcolor{keyword}{typename} T, \textcolor{keywordtype}{size\_t} reserved = 10, u32 growth\_numerator = 3, u32 growth\_denominator = 2, u32 decay\_percent\_threshold = 30, \textcolor{keywordtype}{bool} threaded = false>}
\DoxyCodeLine{9     \textcolor{keyword}{struct }\mbox{\hyperlink{structvtl_1_1Queue}{Queue}}}
\DoxyCodeLine{10     \{}
\DoxyCodeLine{11         \mbox{\hyperlink{structvtl_1_1Queue_a57676627fa1db451b7938abdc00c4e74}{Queue}}()}
\DoxyCodeLine{12         \{}
\DoxyCodeLine{13             \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = reserved;}
\DoxyCodeLine{14             \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}}   = 0;}
\DoxyCodeLine{15             \textcolor{keywordflow}{if} (reserved > 0)}
\DoxyCodeLine{16             \{}
\DoxyCodeLine{17                 \textcolor{comment}{// \_array = static\_cast<T *>(malloc(\_size * sizeof(T)));}}
\DoxyCodeLine{18             \}}
\DoxyCodeLine{19         \}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21         \mbox{\hyperlink{structvtl_1_1Queue_aeef60edf597d55656e0552bd871fda0c}{\string~Queue}}()}
\DoxyCodeLine{22         \{}
\DoxyCodeLine{23             \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} != \textcolor{keyword}{nullptr})}
\DoxyCodeLine{24             \{}
\DoxyCodeLine{25                 \textcolor{comment}{// free(\_array);}}
\DoxyCodeLine{26                 \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{27             \}}
\DoxyCodeLine{28         \}}
\DoxyCodeLine{29 }
\DoxyCodeLine{30         \mbox{\hyperlink{structvtl_1_1Queue_ab3d1e2a584e03b5bf86609e4390901ca}{Queue}}(\textcolor{keyword}{const} \mbox{\hyperlink{structvtl_1_1Queue}{Queue}} \&) = \textcolor{keyword}{delete};}
\DoxyCodeLine{31         \mbox{\hyperlink{structvtl_1_1Queue}{Queue}} \&\mbox{\hyperlink{structvtl_1_1Queue_ab93a1972c8b0be7b7f70b500c5c62bb7}{operator=}}(\textcolor{keyword}{const} \mbox{\hyperlink{structvtl_1_1Queue}{Queue}} \&) = \textcolor{keyword}{delete};}
\DoxyCodeLine{32 }
\DoxyCodeLine{33         T *\mbox{\hyperlink{structvtl_1_1Queue_ac0d8cd8850e7eb9f85fa09254a66545e}{front}}()}
\DoxyCodeLine{34         \{}
\DoxyCodeLine{35             \textcolor{keywordflow}{if} (threaded)}
\DoxyCodeLine{36                 \mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}}.lock();}
\DoxyCodeLine{37             assert(\mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} > 0 \&\& \textcolor{stringliteral}{"{}No \_array in queue!"{}});}
\DoxyCodeLine{38             T *item = \&\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}}[\mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} -\/ 1];}
\DoxyCodeLine{39             \textcolor{keywordflow}{if} (threaded)}
\DoxyCodeLine{40                 \mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}}.unlock();}
\DoxyCodeLine{41             \textcolor{keywordflow}{return} item;}
\DoxyCodeLine{42         \}}
\DoxyCodeLine{43 }
\DoxyCodeLine{44         \textcolor{keywordtype}{void} \mbox{\hyperlink{structvtl_1_1Queue_ac408e12246ea5f630d7ba237d9b7823b}{push}}(\textcolor{keyword}{const} T \&item)}
\DoxyCodeLine{45         \{}
\DoxyCodeLine{46             \textcolor{keywordflow}{if} (threaded)}
\DoxyCodeLine{47                 \mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}}.lock();}
\DoxyCodeLine{48             \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}}++;}
\DoxyCodeLine{49             \mbox{\hyperlink{structvtl_1_1Queue_a6d5a8448705b67146f0e4feeab530f03}{\_reallocate}}();}
\DoxyCodeLine{50             \textcolor{keywordflow}{for} (\mbox{\hyperlink{types_8h_ae9b1af5c037e57a98884758875d3a7c4}{s32}} i = \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} -\/ 1; i >= 1; i-\/-\/)}
\DoxyCodeLine{51             \{}
\DoxyCodeLine{52                 \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}}[i] = \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}}[i -\/ 1];}
\DoxyCodeLine{53             \}}
\DoxyCodeLine{54 }
\DoxyCodeLine{55             \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}}[0] = item;}
\DoxyCodeLine{56 }
\DoxyCodeLine{57             \textcolor{keywordflow}{if} (threaded)}
\DoxyCodeLine{58             \{}
\DoxyCodeLine{59                 \mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}}.unlock();}
\DoxyCodeLine{60                 \mbox{\hyperlink{structvtl_1_1Queue_a9e45a4a4e0b14e31e36da1a9b235e18b}{queue\_cond}}.notify\_one();}
\DoxyCodeLine{61             \}}
\DoxyCodeLine{62         \}}
\DoxyCodeLine{63 }
\DoxyCodeLine{64         \textcolor{keywordtype}{void} \mbox{\hyperlink{structvtl_1_1Queue_ac8615a1ac48712168f91d826ed741bdb}{pop}}()}
\DoxyCodeLine{65         \{}
\DoxyCodeLine{66             assert(!\mbox{\hyperlink{structvtl_1_1Queue_aa5a2a9bd272bc6ea689082d71df72d7d}{empty}}() \&\& \textcolor{stringliteral}{"{}No elements to pop!"{}});}
\DoxyCodeLine{67             \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}}-\/-\/;}
\DoxyCodeLine{68             \mbox{\hyperlink{structvtl_1_1Queue_a6d5a8448705b67146f0e4feeab530f03}{\_reallocate}}();}
\DoxyCodeLine{69         \}}
\DoxyCodeLine{70 }
\DoxyCodeLine{71         \textcolor{keywordtype}{void} \mbox{\hyperlink{structvtl_1_1Queue_a625f7cd2db6867c26f27dd8ebb8cd65f}{pop\_wait}}()}
\DoxyCodeLine{72         \{}
\DoxyCodeLine{73             assert(threaded \&\& \textcolor{stringliteral}{"{}Queue must be threaded before you can pop wait!"{}});}
\DoxyCodeLine{74             std::unique\_lock<vtl::mutex> lock(\mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}});}
\DoxyCodeLine{75             \textcolor{keywordflow}{while} (\mbox{\hyperlink{structvtl_1_1Queue_aa5a2a9bd272bc6ea689082d71df72d7d}{empty}}())}
\DoxyCodeLine{76             \{}
\DoxyCodeLine{77                 \mbox{\hyperlink{structvtl_1_1Queue_a9e45a4a4e0b14e31e36da1a9b235e18b}{queue\_cond}}.wait(lock);}
\DoxyCodeLine{78             \}}
\DoxyCodeLine{79             \mbox{\hyperlink{structvtl_1_1Queue_ac8615a1ac48712168f91d826ed741bdb}{pop}}();}
\DoxyCodeLine{80         \}}
\DoxyCodeLine{81 }
\DoxyCodeLine{82         \textcolor{keywordtype}{bool} \mbox{\hyperlink{structvtl_1_1Queue_aa5a2a9bd272bc6ea689082d71df72d7d}{empty}}()\textcolor{keyword}{ const }\{ \textcolor{keywordflow}{return} \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} == 0; \}}
\DoxyCodeLine{83 }
\DoxyCodeLine{84         \textcolor{keywordtype}{void} \mbox{\hyperlink{structvtl_1_1Queue_addae4488b0c2f2da9dc58b0b9a09c9a0}{clear}}()}
\DoxyCodeLine{85         \{}
\DoxyCodeLine{86             \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}}   = 0;}
\DoxyCodeLine{87             \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = reserved;}
\DoxyCodeLine{88             \textcolor{keywordflow}{if} (reserved > 0)}
\DoxyCodeLine{89             \{}
\DoxyCodeLine{90                 \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} == \textcolor{keyword}{nullptr})}
\DoxyCodeLine{91                 \{}
\DoxyCodeLine{92                     \textcolor{comment}{// \_array = (T *)malloc(\_size * sizeof(T));}}
\DoxyCodeLine{93                 \}}
\DoxyCodeLine{94                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{95                 \{}
\DoxyCodeLine{96                     \textcolor{comment}{// \_array = (T *)realloc(\_array, \_size * sizeof(T));}}
\DoxyCodeLine{97                 \}}
\DoxyCodeLine{98             \}}
\DoxyCodeLine{99         \}}
\DoxyCodeLine{100 }
\DoxyCodeLine{101         \textcolor{keywordtype}{void} \mbox{\hyperlink{structvtl_1_1Queue_a6d5a8448705b67146f0e4feeab530f03}{\_reallocate}}()}
\DoxyCodeLine{102         \{}
\DoxyCodeLine{103             \textcolor{comment}{// Only reallocate and expand the array if we need to}}
\DoxyCodeLine{104             \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} > \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}})}
\DoxyCodeLine{105             \{}
\DoxyCodeLine{106                 \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} * \mbox{\hyperlink{structvtl_1_1Queue_aba5af9fccdd15aa7183bef9c392af0ef}{growth\_factor}};}
\DoxyCodeLine{107             \}}
\DoxyCodeLine{108             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ((\mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}})\mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} / (\mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}})\mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} < (\mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}})decay\_percent\_threshold / 100.0)}
\DoxyCodeLine{109             \{}
\DoxyCodeLine{110                 \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} * \mbox{\hyperlink{structvtl_1_1Queue_aba5af9fccdd15aa7183bef9c392af0ef}{growth\_factor}};}
\DoxyCodeLine{111             \}}
\DoxyCodeLine{112             \textcolor{keywordflow}{else}}
\DoxyCodeLine{113             \{}
\DoxyCodeLine{114                 \textcolor{keywordflow}{return};}
\DoxyCodeLine{115             \}}
\DoxyCodeLine{116 }
\DoxyCodeLine{117             \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} < reserved)}
\DoxyCodeLine{118             \{}
\DoxyCodeLine{119                 \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = reserved;}
\DoxyCodeLine{120             \}}
\DoxyCodeLine{121 }
\DoxyCodeLine{122             \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} == 0)}
\DoxyCodeLine{123             \{}
\DoxyCodeLine{124                 \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} != \textcolor{keyword}{nullptr})}
\DoxyCodeLine{125                 \{}
\DoxyCodeLine{126                     \textcolor{comment}{// free(\_array);}}
\DoxyCodeLine{127                     \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{128                 \}}
\DoxyCodeLine{129             \}}
\DoxyCodeLine{130             \textcolor{keywordflow}{else}}
\DoxyCodeLine{131             \{}
\DoxyCodeLine{132                 \textcolor{keywordflow}{if} (\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} == \textcolor{keyword}{nullptr})}
\DoxyCodeLine{133                 \{}
\DoxyCodeLine{134                     \mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} = (T *)\mbox{\hyperlink{namespaceVultr_a636d8806d0b2cb78992343f8b632940a}{malloc}}(\mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} * \textcolor{keyword}{sizeof}(T));}
\DoxyCodeLine{135                 \}}
\DoxyCodeLine{136                 \textcolor{keywordflow}{else}}
\DoxyCodeLine{137                 \{}
\DoxyCodeLine{138                     \textcolor{comment}{// \_array = (T *)realloc(\_array, \_size * sizeof(T));}}
\DoxyCodeLine{139                 \}}
\DoxyCodeLine{140             \}}
\DoxyCodeLine{141         \}}
\DoxyCodeLine{142 }
\DoxyCodeLine{143         \textcolor{comment}{// The internal array}}
\DoxyCodeLine{144         T *\mbox{\hyperlink{structvtl_1_1Queue_a5a88c1ab2397ec97e0d72b5423263413}{\_array}} = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{145 }
\DoxyCodeLine{146         \textcolor{comment}{// Spaces len (not bytes)}}
\DoxyCodeLine{147         \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structvtl_1_1Queue_aa63828f1b5f98e7e99a582faf159ad3e}{len}} = 0;}
\DoxyCodeLine{148 }
\DoxyCodeLine{149         \textcolor{comment}{// Space in \_array (not bytes)}}
\DoxyCodeLine{150         \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{structvtl_1_1Queue_a7ce9517bbf2fcb6d8ce48a2ed236b8f4}{\_size}} = reserved;}
\DoxyCodeLine{151 }
\DoxyCodeLine{152         \textcolor{comment}{// To make sure that the buffer expansion is geometric}}
\DoxyCodeLine{153         \mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}} \mbox{\hyperlink{structvtl_1_1Queue_aba5af9fccdd15aa7183bef9c392af0ef}{growth\_factor}} = (\mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}})growth\_numerator / (\mbox{\hyperlink{types_8h_a94dab5770726ccbef8c7d026cfbdf8e5}{f64}})growth\_denominator;}
\DoxyCodeLine{154 }
\DoxyCodeLine{155         \mbox{\hyperlink{namespacevtl_adc91b7ec14024659cb575eeabc7f0d77}{vtl::mutex}} \mbox{\hyperlink{structvtl_1_1Queue_a16d6adf1012891a2648afd0f10dede81}{queue\_mutex}};}
\DoxyCodeLine{156         \mbox{\hyperlink{namespacevtl_a7d8495d7884ddb7182a5b2db93ab0915}{vtl::condition\_variable}} \mbox{\hyperlink{structvtl_1_1Queue_a9e45a4a4e0b14e31e36da1a9b235e18b}{queue\_cond}};}
\DoxyCodeLine{157     \};}
\DoxyCodeLine{158 \} \textcolor{comment}{// namespace vtl}}

\end{DoxyCode}
